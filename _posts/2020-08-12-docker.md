---
title: "Docker container for machine learning environments"
classes: wide
sitemap: true
header:
  teaser: "assets/images/markup-syntax-highlighting-teaser.jpg"
categories:
tags:
  - tutorial
toc: true
toc_label: "Table of Contents"
description: Docker
---
## Docker basic

Ref [docker doc](https://docs.docker.com/) and `docker --help`

Here is a good docker [tutorial](https://ropenscilabs.github.io/r-docker-tutorial/)

### docker image download and commit

```
docker pull [OPTIONS] NAME[:TAG|@DIGEST]
docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]
```

### check docker

```
docker ps
docker images
docker inspect 
```

Others

```
docker run
docker rmi
docker rm 
docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH
```

<kbd>Ctrl</kbd>+<kbd>p</kbd> then <kbd>Ctrl</kbd>+<kbd>q</kbd> will  turn container interactive mode to daemon mode.  If you want to reattach, run

```
docker attach [OPTIONS] CONTAINER
```

### Setup docker

run docker without sudo 

```
sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker 
```

### Push to docker hub

```bash
docker login
docker tag image_id yourhubusername/REPOSITORY_NAME:tag
docker push yourhubusername/REPOSITORY_NAME
```

### Dockerfile

a basic template, ref. [dockerfile](https://docs.docker.com/engine/reference/builder/)

```
FROM ubuntu:18.04
COPY . /app
EXPOSE 9000
RUN make /app
CMD python /app/app.py
```

docker-compose.yml ref [compose](https://docs.docker.com/compose/compose-file/)

```
version: "3.8"
services:
  webapp:
    build:
      context: ./dir
      dockerfile: Dockerfile-alternate
      args:
        buildno: 1
```

[a full example of django](https://docs.docker.com/compose/django/) dockerfile and docker-compose
## Docker proxy

1. set proxy for `docker pull`, ref [docker-proxy](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy)

```
sudo mkdir -p /etc/systemd/system/docker.service.d
vim /etc/systemd/system/docker.service.d/http-proxy.conf
```

2. add 

>```
>[Service]
>Environment="HTTP_PROXY=socks5://127.0.0.1:1080"
>Environment="HTTPS_PROXY=socks5://127.0.0.1:1080"
>```

where `127.0.0.1:1080` is your proxy forward port.

3. Take effect

```
sudo systemctl daemon-reload
sudo systemctl restart docker
```

4. Verify and enjoy

```
sudo systemctl show --property=Environment docker
```
## Docker with cuda

refer [nvidia-docker](https://github.com/NVIDIA/nvidia-docker)

setup nvidia-container-toolkit

```bash
# Add the package repositories
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update && sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker
```

pull cuda image depending your cuda version 

```bash
docker pull nvidia/cuda:10.2-basic
```

run docker

```bash
docker run --gpus all --ipc=host --net host -it --rm -v /dev/shm:/dev/shm -v $(pwd):/workspace --user $(id -u):$(id -g) nvidia/cuda:10.2-runtime-ubuntu18.04
```

`-v /dev/shm:/dev/shm` for torch distributed train with nccl back-end

or create a docker file

````bash
ARG DOCKER_BASE_IMAGE=nvidia/cuda:10.2-basic
FROM $DOCKER_BASE_IMAGE
# remove cuda list avoid gpg error when apt-get
RUN rm /etc/apt/sources.list.d/cuda.list && rm /etc/apt/sources.list.d/nvidia-ml.list
RUN apt-get update && apt-get -y install sudo 

COPY pre-install.sh .
RUN ./pre-install.sh

ARG UID=1000
ARG GID=1000
ARG USER=docker
# default password for user
ARG PW=docker
RUN useradd -m ${USER} --uid=${UID} -s /bin/bash  && echo "${USER}:${PW}" | chpasswd && adduser ${USER} sudo
# Setup default user, when enter docker container
USER ${USER}
WORKDIR /home/${USER}
````
you can put pre-installed script as 

```
apt-get install -y iputils-ping
apt-get install -y vim
apt-get install -y wget
apt-get install -y git
```

build by

```bash
export UID=$(id -u)
export GID=$(id -g)
sudo docker build --build-arg USER=$USER \
			 --build-arg UID=$UID \
             --build-arg GID=$GID \
			 -t mycuda \
			 -f Dockerfile \
			 .
```

run docker with 

```bash
docker run --gpus all --ipc=host --net host -it -v /dev/shm:/dev/shm -v $(pwd):/home/docker/workspace --hostname mycontainer --user docker mycuda
```

add `--rm ` if you want to remove the container after it exit.

**re-attach** to stopped container by 

```
docker start -ai [container name or id]
```

## Container using Host proxy

I set up a proxy on host:8118, and I want my container use it to access network, How to achieve this?

### 1. Setup client proxy

* According [docker document](https://docs.docker.com/network/proxy/), set up proxy for docker is by setting environment variables, there are two method to do it, one is create/edit the file `~/.docker/config.json`, add following to it.

```json
{
 "proxies":
 {
   "default":
   {
     "httpProxy": "http://127.0.0.1:8118",
     "httpsProxy": "http://127.0.0.1:8118",
     "noProxy": "localhost"
   }
 }
}
```

After set the config, when you rebuild the docker image, the proxy will automatically set up for the image. but there is one thing should be noticed, that is   when building the docker image, you may run some commands using network (e.g. `apt update)` within the container, but you do not finished the proxy set up. So these commands could fail duo to network error. Here you have to make it use the host network when building docker image by using

```bash
docker build --net host xxx
```

* another way is set the environment variables manually in Dockerfile by `ENV HTTP_PROXY "http://127.0.0.1:8118"`, or your can just set it in docker CLI.

### 2. Setup network mapping

* There are two ways to map the host network to container, one is just port all host network to container by using `docker run --net host`. 

* Another way is only map the proxy port to the your host by `docker run -p 8118:8118`.







 